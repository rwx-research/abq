name: Test and package development builds

on:
  workflow_call:
    inputs:
      ref:
        description: 'ref to build'
        required: true
        type: string
    outputs:
      abq_version:
        description: "Released ABQ version"
        value: ${{ jobs.release.outputs.abq_version }}
    secrets:
      SSH_KEY_ABQ_JEST:
        required: true
      RWX_STAGING_CREATE_RELEASE_ACCESS_TOKEN:
        required: true
      AWS_S3_ABQ_RELEASES_STAGING_ACCESS_KEY_ID:
        required: true
      AWS_S3_ABQ_RELEASES_STAGING_SECRET_ACCESS_KEY:
        required: true

jobs:
  release:
    name: Build, Upload, Release ABQ
    # We only need x86-64 statically-linked binaries for development testing.
    runs-on: ubuntu-latest
    outputs:
      abq_version: ${{ steps.abq_version.outputs.abq_version }}
    env:
      AWS_DEFAULT_REGION: us-east-2
      AWS_DEFAULT_OUTPUT: json
      PLATFORM: linux_x86-64
      RUST_TARGET: x86_64-unknown-linux-musl
      ABQ_DEVELOPMENT_BUILD: 1
      ABQ_NO_REBUILD: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # get whole history for versioning

      - name: Mark safe directory
        run: |
          # For some reason we need this, even though actions/checkout sets
          # safe.directory by default?
          # Perhaps it is because we work in a container?
          git config --global --add safe.directory "$PWD"
          git describe

      # this may not be unecessary when https://github.com/actions/checkout/issues/882 is resolved
      - name: re-fetch overwritten tag
        run: git fetch --tags --force

      - name: Install musl libc tools
        run: |
          sudo apt-get install -y musl-tools

      - name: Restore cargo cache
        uses: actions/cache@v3.0.11
        env:
          cache-name: ci
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-release-linux_x86-64-musl-${{ hashFiles('rust-toolchain.toml')}}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            cargo-release-linux_x86-64-musl-${{ hashFiles('rust-toolchain.toml')}}-
      - name: Install Rust toolchain
        uses: rwx-research/rust-toolchain@abq
        with:
          toolchain: 1.65.0
          target: ${{ env.RUST_TARGET }}
          components: clippy, rustfmt

      - name: Check formatting
        uses: actions-rs/cargo@v1.0.3
        with:
          command: fmt
          args: -- --check

      - name: Run lints
        uses: actions-rs/cargo@v1.0.3
        with:
          command: clippy
          args: --workspace --tests --release --all-features --target=${{ env.RUST_TARGET }} -- --deny warnings

      - name: Lint github workflows
        run: |
          echo "::add-matcher::.github/actionlint-matcher.json"
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/3a2f2c755b6442ec7999b28dfd107e1bb9853389/scripts/download-actionlint.bash)
          ./actionlint -color
        shell: bash

      # setup testdata
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
          cache: 'npm'
          cache-dependency-path: 'testdata/**/package-lock.json'

      - name: Load test dependencies
        run: |
          scripts/init_testdata

      # End setup testdata

      - name: Build release with tests
        run: |
          cargo build --tests --release --all-features --target="$RUST_TARGET"

      - name: Run tests with cargo
        timeout-minutes: 4
        if: github.run_attempt == 1
        run: |
          cargo test --release --all-features --target="$RUST_TARGET"
        env:
          CI: false

      - name: Run retried tests with cargo, including debug output
        timeout-minutes: 5
        if: github.run_attempt > 1
        run: |
          export ABQ_DEBUG_CLI_TESTS_FOR_CI=1
          cargo test --release --all-features --target="$RUST_TARGET" -- --nocapture
        env:
          CI: false

      - name: Prepare release environment
        run: |
          ABQ_VERSION="$(cat build_artifact/abq_version.txt)"
          RELEASE_NAME="abq_${ABQ_VERSION}_linux_x86-64"
          RELEASE_ARCHIVE="${RELEASE_NAME}.tar.gz"
          RELEASE_S3_OBJECT="abq/${ABQ_VERSION}/${RELEASE_ARCHIVE}"
          {
            echo "ABQ_VERSION=$ABQ_VERSION"
            echo "RELEASE_NAME=$RELEASE_NAME"
            echo "RELEASE_ARCHIVE=$RELEASE_ARCHIVE"
            echo "RELEASE_S3_OBJECT=$RELEASE_S3_OBJECT"
          } >> "$GITHUB_ENV"

      - name: Prepare release
        id: prepare_release
        run: |
          mkdir "${RELEASE_NAME}"
          cp "target/$RUST_TARGET/release/abq" "${RELEASE_NAME}"
          tar -czvf "${RELEASE_ARCHIVE}" "${RELEASE_NAME}"
          echo "filesize=$(wc -c "$RELEASE_ARCHIVE" | awk '{ print $1}')" >> "$GITHUB_OUTPUT"

      - name: Push release to staging S3
        env:
          RELEASE_BUCKET: abq-releases-staging
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_S3_ABQ_RELEASES_STAGING_ACCESS_KEY_ID }} --profile staging
          aws configure set aws_secret_access_key ${{ secrets.AWS_S3_ABQ_RELEASES_STAGING_SECRET_ACCESS_KEY }} --profile staging

          aws s3 cp "$RELEASE_ARCHIVE" "s3://$RELEASE_BUCKET/$RELEASE_S3_OBJECT" --profile staging
          aws s3api put-object-tagging \
            --bucket "$RELEASE_BUCKET" \
            --key "$RELEASE_S3_OBJECT" \
            --tagging "$(jq -n --arg commit "$(git rev-parse HEAD)" '{"TagSet": [{"Key":"commit", "Value": $commit}]}')" \
            --profile staging

          aws s3 cp \
            "s3://$RELEASE_BUCKET/$RELEASE_S3_OBJECT" \
            "s3://$RELEASE_BUCKET/${RELEASE_S3_OBJECT//$ABQ_VERSION/nightly}" \
            --profile staging

      - name: export abq version
        id: abq_version
        run: |
          echo "abq_version=${ABQ_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Analyze filesize
        id: filesize
        run: |
          {
            echo "formatted_filesize=$(printf "%'d" "$FILESIZE")"
            echo "filesize=$FILESIZE"
            echo "smaller_than_4mb=${{ steps.prepare_release.outputs.filesize < 4000000 && 'true' || 'false' }}"
          } >> "$GITHUB_OUTPUT"
        env:
          FILESIZE: ${{ steps.prepare_release.outputs.filesize }}

      - name: Get associated PR
        uses: 8BitJonny/gh-get-current-pr@f4d16fd424adba1334de83b538f6cac7529d4683 # v2.2.0, locking to a ref to avoid supply chain attacks
        id: pr

      - name: Report filesize
        uses: thollander/actions-comment-pull-request@d117ef6afcc405eca3137f55f39a2d4f7d559f6f # v2.3.0, locking to a ref to avoid supply chain attacks
        if: steps.pr.outputs.pr_found == 'true'
        with:
          pr_number: ${{ steps.pr.outputs.number }}
          message: |
            **Zipped Filesize for ${{ github.sha }}** ([run](https://github.com/rwx-research/abq/actions/runs/${{ github.run_id }}))
            ${{ steps.filesize.outputs.smaller_than_4mb == 'true' && ':white_check_mark: smaller than 4MB' || ':x: greater than 4MB' }}
            ${{ steps.filesize.outputs.formatted_filesize }} bytes

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-api:
    name: Release new abq to staging API
    needs: release
    uses: ./.github/workflows/release_staging.yml
    with:
      version: ${{ needs.release.outputs.abq_version }}
    secrets:
      RWX_STAGING_CREATE_RELEASE_ACCESS_TOKEN: ${{ secrets.RWX_STAGING_CREATE_RELEASE_ACCESS_TOKEN }}
